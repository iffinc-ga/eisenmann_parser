<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Eisenmann Invoice PDF Parser</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none;position:sticky;top:0;z-index:100;align-items:center;gap:10px;flex-wrap:wrap}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:260px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-light{background:#f8f9fa;color:#212529;border:1px solid #ced4da}
    .inline-help{font-size:12px;color:#6c757d;margin-left:8px}
    .db-banner{padding:12px 20px;background:#fff3cd;border-bottom:1px solid #ffc107;font-size:13px;display:flex;align-items:center;gap:10px}
    .db-status{font-weight:600}
    .db-status.loading{color:#856404}
    .db-status.loaded{color:#155724}
    .db-status.offline{color:#6c757d}
    .db-btn{padding:4px 10px;border-radius:4px;border:1px solid #856404;background:#fff;font-size:11px;cursor:pointer}
    .stats{padding:20px;display:none;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1532px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{background:#343a40;color:#fff;padding:8px;text-align:left;font-weight:600;font-size:13px;border:none}
    .table-body-wrapper{max-height:560px;overflow:auto}
    .table-body{min-width:1532px}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:6px 6px;border-bottom:1px solid #dee2e6;background:#fff}
    .table-body tr:hover td{background:#f8f9fa}
    .table-body td input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px}
    .table-body td select{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px;background:#fff}
    .table-body td input:focus,.table-body td select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.15)}
    .readonly{background:#e9ecef!important}
    .actions{text-align:center;white-space:nowrap}
    .actions button{padding:4px 8px;font-size:11px;margin:0 2px}
    .alert{margin:0 20px 20px;border-radius:4px;padding:10px 14px;font-size:13px;display:none}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .table-header table,.table-body table{table-layout:fixed}
    .table-header th:nth-child(1),.table-body td:nth-child(1){width:52px!important}
    .table-header th:nth-child(2),.table-body td:nth-child(2){width:190px!important}
    .table-header th:nth-child(3),.table-body td:nth-child(3){width:80px!important}
    .table-header th:nth-child(4),.table-body td:nth-child(4){width:60px!important}
    .table-header th:nth-child(5),.table-body td:nth-child(5){width:110px!important}
    .table-header th:nth-child(6),.table-body td:nth-child(6){width:110px!important}
    .table-header th:nth-child(7),.table-body td:nth-child(7){width:110px!important}
    .table-header th:nth-child(8),.table-body td:nth-child(8){width:110px!important}
    .table-header th:nth-child(9),.table-body td:nth-child(9){width:100px!important}
    .table-header th:nth-child(10),.table-body td:nth-child(10){width:80px!important}
    .table-header th:nth-child(11),.table-body td:nth-child(11){width:100px!important}
    .table-header th:nth-child(12),.table-body td:nth-child(12){width:120px!important}
    .table-header th:nth-child(13),.table-body td:nth-child(13){width:110px!important}
    .metal-badge{display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;font-size:11px;font-weight:600}
    .metal-steel{background:#c0c0c0;color:#333}
    .metal-copper{background:#b87333;color:#fff}
    .metal-aluminum{background:#a8a9ad;color:#fff}
    .metal-none{background:#d4edda;color:#155724;padding:4px 8px}
    .metal-info{font-size:11px;line-height:1.4}
    .country-melt{font-style:italic;color:#6c757d;font-size:10px;display:block;margin-top:2px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìÑ Eisenmann Invoice PDF Parser</h1>
    <p>Parse Eisenmann customs invoices into editable line items and export to Descartes CI template.</p>
  </div>

  <div class="db-banner">
    <span id="dbStatus" class="db-status loading">DB: not loaded</span>
    <span id="dbInfo">Will try to load updated_eisenmann_db.xlsx from GitHub...</span>
    <button id="retryDbBtn" class="db-btn">Retry DB</button>
    <button id="uploadDbBtn" class="db-btn">Upload DB File</button>
    <button id="offlineDbBtn" class="db-btn">Work offline</button>
    <input type="file" id="dbFileInput" accept=".xlsx" style="display:none" />
  </div>

  <div class="upload-section" id="uploadSection">
    <div class="upload-box" id="uploadBox">
      <h2>üì§ Upload Eisenmann PDF</h2>
      <p style="margin-top:10px;color:#6c757d">Click or drag &amp; drop your multi-invoice PDF here</p>
      <input type="file" id="fileInput" accept=".pdf,application/pdf" />
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div><strong>Processing PDF...</strong></div>
  </div>

  <div class="alert" id="alert"></div>

  <div class="controls" id="controls">
    <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
    <button class="btn-success" onclick="exportToDescartes()">üìä Export to Descartes CI Template</button>
    <button class="btn-primary" onclick="resetUpload()">üì§ New Upload</button>
    <button class="btn-light" onclick="debugDumpData()">üêõ Debug: Dump Data</button>
    <span class="inline-help">Use Tab / Shift+Tab to move across cells. Edit invoice totals/dates at the top.</span>
  </div>

  <div class="stats" id="stats">
    <div class="stat">
      <div class="stat-label">Invoice Number</div>
      <div class="stat-value" id="statInvoice">-</div>
    </div>
    <div class="stat editable">
      <div class="stat-label">Invoice Date (Editable)</div>
      <input autocomplete="off" type="text" id="statDate" placeholder="MM/DD/YYYY"
             onchange="updateInvoiceField('invoice_date', this.value)">
    </div>
    <div class="stat editable">
      <div class="stat-label">Supplier (Editable)</div>
      <input autocomplete="off" type="text" id="statSupplier" placeholder="Supplier name"
             onchange="updateInvoiceField('supplier', this.value)">
    </div>
    <div class="stat">
      <div class="stat-label">Total Line Items</div>
      <div class="stat-value" id="statItems">0</div>
    </div>
    <div class="stat editable">
      <div class="stat-label">Invoice Total (Editable)</div>
      <input autocomplete="off" type="number" step="0.01" id="statTotal" placeholder="0.00"
             onchange="updateInvoiceTotal(this.value)">
    </div>
    <div class="stat">
      <div class="stat-label">Line Items Sum</div>
      <div class="stat-value" id="statSum">$0.00</div>
    </div>
    <div class="stat">
      <div class="stat-label">Difference</div>
      <div class="stat-value" id="statDiff">$0.00</div>
    </div>
    <div class="stat">
      <div class="stat-label">Gross Weight (KG)</div>
      <div class="stat-value" id="statGrossWeight">-</div>
    </div>
    <div class="stat">
      <div class="stat-label">Net Weight (KG)</div>
      <div class="stat-value" id="statNetWeight">-</div>
    </div>
  </div>

  <div class="table-container" id="tableContainer">
    <div class="table-header-wrapper">
      <div class="table-header">
        <table>
          <thead>
          <tr>
            <th>Pos</th>
            <th>Material / Part #</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Unit Price</th>
            <th>Line Total</th>
            <th>Net Weight</th>
            <th>Country</th>
            <th>Metal Type</th>
            <th title="Metal percentage (typically 100)">Metal %</th>
            <th>Metal Wt (kg)</th>
            <th>Melt Country</th>
            <th>Actions</th>
          </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="table-body-wrapper" id="tableBodyWrapper">
      <div class="table-body">
        <table>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let invoices = [];
  let currentInvoice = null;
  
  // Database state
  let eisenmannDb = [];
  let htsCodesDb = [];
  let supplierMidDb = [];
  let steelAlumListDb = [];

  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo: 'eisenmann_parser',
    branch: 'main',
    filePath: 'updated_eisenmann_db.xlsx'
  };

  const dbStatusEl = document.getElementById('dbStatus');
  const dbInfo = document.getElementById('dbInfo');
  const retryDbBtn = document.getElementById('retryDbBtn');
  const uploadDbBtn = document.getElementById('uploadDbBtn');
  const dbFileInput = document.getElementById('dbFileInput');
  const offlineDbBtn = document.getElementById('offlineDbBtn');

  function setDbBanner(state, msg, info) {
    if (!dbStatusEl) return;
    let cls = 'db-status';
    if (state === 'loading') cls += ' loading';
    else if (state === 'loaded') cls += ' loaded';
    else if (state === 'offline') cls += ' offline';
    dbStatusEl.className = cls;
    dbStatusEl.textContent = msg;
    if (dbInfo && info != null) dbInfo.textContent = info;
  }

  function abortableFetch(url, timeoutMs = 8000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    return fetch(url, { signal: ctrl.signal }).finally(() => clearTimeout(t));
  }

  async function fetchAndReadWorkbook(url, useAbort) {
    const res = useAbort ? await abortableFetch(url, 8000) : await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf, { type: 'array' });
  }

  async function hydrateDbFromWorkbook(workbook) {
    console.log('[DB] Available sheet names:', workbook.SheetNames);
    
    // Load Eisenmann sheet
    const eisenmannSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('eisenmann')) || workbook.SheetNames[0];
    eisenmannDb = XLSX.utils.sheet_to_json(workbook.Sheets[eisenmannSheet], { defval: '' });
    console.log(`[DB] Loaded ${eisenmannSheet}: ${eisenmannDb.length} rows`);

    // Load HTS codes sheet if exists
    const htsSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('hts'));
    if (htsSheet) {
      htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets[htsSheet], { defval: '' });
      console.log(`[DB] Loaded ${htsSheet}: ${htsCodesDb.length} rows`);
    }

    // Load supplier MID sheet if exists
    const midSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('mid'));
    if (midSheet) {
      supplierMidDb = XLSX.utils.sheet_to_json(workbook.Sheets[midSheet], { defval: '' });
      console.log(`[DB] Loaded ${midSheet}: ${supplierMidDb.length} rows`);
    }

    // Load Steel_Alum_list sheet - try multiple name patterns
    const steelAlumSheet = workbook.SheetNames.find(n => {
      const lower = n.toLowerCase().replace(/[_\s]/g, '');
      return lower.includes('steelalum') || n === 'Steel_Alum_list';
    });
    
    console.log('[DB] Looking for Steel_Alum_list sheet...');
    console.log('[DB] Found sheet name:', steelAlumSheet);
    
    if (steelAlumSheet) {
      steelAlumListDb = XLSX.utils.sheet_to_json(workbook.Sheets[steelAlumSheet], { defval: '' });
      console.log(`[DB] Loaded ${steelAlumSheet}: ${steelAlumListDb.length} rows`);
      if (steelAlumListDb.length > 0) {
        console.log('[DB] Steel_Alum_list columns:', Object.keys(steelAlumListDb[0]));
      }
    } else {
      console.warn('[DB] Steel_Alum_list sheet not found in workbook!');
    }

    setDbBanner('loaded', 'DB: Loaded successfully', `${eisenmannDb.length} parts`);
  }

  async function tryLoadDbFromGitHub() {
    try {
      setDbBanner('loading', 'DB: Loading from GitHub...', '');
      const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.filePath}`;
      const wb = await fetchAndReadWorkbook(rawUrl, true);
      await hydrateDbFromWorkbook(wb);
    } catch (err) {
      console.error('[DB] GitHub load failed:', err);
      setDbBanner('offline', 'DB: Failed to load', 'Working offline without database');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initEventListeners();
    tryLoadDbFromGitHub();
  });

  function initEventListeners() {
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');

    uploadBox.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });
    uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
    });

    retryDbBtn.addEventListener('click', tryLoadDbFromGitHub);
    
    uploadDbBtn.addEventListener('click', () => {
      dbFileInput.click();
    });
    
    dbFileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      
      try {
        setDbBanner('loading', 'DB: Loading from file...', '');
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        await hydrateDbFromWorkbook(workbook);
      } catch (err) {
        console.error('[DB] File load failed:', err);
        setDbBanner('offline', 'DB: Failed to load file', err.message);
      }
    });
    
    offlineDbBtn.addEventListener('click', () => {
      setDbBanner('offline', 'DB: Working offline', 'Database features disabled');
    });

    document.getElementById('invoiceSelect').addEventListener('change', (e) => {
      if (e.target.value) displayInvoice(e.target.value);
    });
  }

  function lookupTariffsByPart(partNumber) {
    if (!eisenmannDb.length) return [];
    const upper = String(partNumber).toUpperCase().trim();
    // Try both column name formats for compatibility
    const row = eisenmannDb.find(r => 
      String(r['Part Number'] || r['part number'] || '').toUpperCase().trim() === upper
    );
    if (!row) return [];
    
    const tariffs = [];
    for (let i = 1; i <= 5; i++) {
      const t = row[`Tariff${i}`] || row[`tariff${i}`] || '';
      if (t) tariffs.push(String(t).trim());
    }
    return tariffs;
  }

  function lookupHtsUom(hts) {
    if (!htsCodesDb.length) return { uom1: '', uom2: '' };
    const htsStr = String(hts).trim();
    const row = htsCodesDb.find(r => String(r.HTS || r.hts || '').trim() === htsStr);
    if (!row) return { uom1: '', uom2: '' };
    return {
      uom1: row.UOM1 || row.uom1 || '',
      uom2: row.UOM2 || row.uom2 || ''
    };
  }

  async function handleFileSelect(file) {
    if (!file || file.type !== 'application/pdf') {
      showAlert('Please select a valid PDF file', 'error');
      return;
    }

    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('alert').style.display = 'none';

    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const fullText = await extractAllText(pdf);
      invoices = parseMultipleInvoices(fullText);

      if (invoices.length === 0) {
        throw new Error('No invoices found in PDF');
      }

      document.getElementById('loading').style.display = 'none';
      populateInvoiceDropdown();
      displayInvoice(invoices[0].invoice_number);
      showAlert(`‚úì Successfully parsed ${invoices.length} invoice(s)`, 'success');
    } catch (error) {
      console.error('Error processing PDF:', error);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('uploadSection').style.display = 'block';
      showAlert(`Error processing PDF: ${error.message}`, 'error');
    }
  }

  async function extractAllText(pdf) {
    let fullText = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      const pageText = textContent.items.map(item => item.str).join(' ');
      fullText += pageText + '\n\n';
    }
    return fullText;
  }

  function parseMultipleInvoices(text) {
    const blocks = text.split(/Invoice no\. \/ Date:/).filter(b => b.trim());
    const invoiceList = [];

    blocks.forEach((block, idx) => {
      if (idx === 0 && !block.includes('Eisenmann')) return;
      const invoiceMatch = block.match(/(\d+)\s*\/\s*(\d{2})\/(\d{2})\/(\d{4})/);
      if (!invoiceMatch) return;

      const invoiceNumber = invoiceMatch[1];
      const invoiceDate = `${invoiceMatch[2]}/${invoiceMatch[3]}/${invoiceMatch[4]}`;

      const supplierMatch = block.match(/Supplier[:\s]+([^\n]+)/i) || block.match(/Your Customer No\.:[^\n]*\n([^\n]+)/);
      const supplier = supplierMatch ? supplierMatch[1].trim() : 'Eisenmann GmbH';

      const netAmountMatch = block.match(/Net amount\s+([\d,]+\.?\d*)/i);
      const netAmount = netAmountMatch ? parseFloat(netAmountMatch[1].replace(/,/g, '')) : 0;

      // Parse gross and net weights
      const grossWeightMatch = block.match(/Gross Weight\s+([\d,]+\.?\d*)\s*KG/i);
      const netWeightMatch = block.match(/Net Weight\s+([\d,]+\.?\d*)\s*KG/i);
      const grossWeight = grossWeightMatch ? parseFloat(grossWeightMatch[1].replace(/,/g, '')) : 0;
      const netWeight = netWeightMatch ? parseFloat(netWeightMatch[1].replace(/,/g, '')) : 0;

      const lines = parseLineItems(block);

      invoiceList.push({
        invoice_number: invoiceNumber,
        invoice_date: invoiceDate,
        supplier: supplier,
        net_amount: netAmount,
        gross_weight: grossWeight,
        net_weight: netWeight,
        line_items: lines
      });
    });

    return invoiceList;
  }

  function parseLineItems(block) {
    const lines = [];
    const lineRegex = /(\d{6})\s+([A-Z]\d+)\s+(\d+)\s+PC\s+([\d,]+\.?\d*)\s+USD\s+1\s+PC\s+([\d,]+\.?\d*)/g;
    let match;

    while ((match = lineRegex.exec(block)) !== null) {
      const itemNumber = match[1];
      const materialCode = match[2];
      const quantity = parseInt(match[3]);
      const unitPrice = parseFloat(match[4].replace(/,/g, ''));
      const lineTotal = parseFloat(match[5].replace(/,/g, ''));

      const descStartIdx = block.indexOf(materialCode, match.index) + materialCode.length;
      const descEndIdx = block.indexOf('Commodity Code', descStartIdx);
      let description = '';
      if (descEndIdx > descStartIdx) {
        description = block.substring(descStartIdx, descEndIdx).trim().split('\n')[0].trim();
      }

      const commodityMatch = block.substring(match.index, match.index + 500).match(/Commodity Code[^\d]*(\d{8})/);
      const commodityCode = commodityMatch ? commodityMatch[1] : '';

      const countryMatch = block.substring(match.index, match.index + 500).match(/Country of origin:\s*([A-Z]{2,})/i);
      const country = countryMatch ? countryMatch[1] : 'Germany';

      // Parse line-level net weight if present
      let lineNetWeight = '';
      const lineNetWeightMatch = block.substring(match.index, match.index + 500).match(/Net Weight\s+([\d,]+\.?\d*)\s*KG/i);
      if (lineNetWeightMatch) {
        lineNetWeight = parseFloat(lineNetWeightMatch[1].replace(/,/g, ''));
      }

      const metalInfo = parseMetalContent(block.substring(match.index, match.index + 800));

      lines.push({
        item_number: itemNumber,
        material_code: materialCode,
        description: description,
        quantity: quantity,
        unit: 'PC',
        unit_price: unitPrice,
        line_total: lineTotal,
        net_weight: lineNetWeight,
        commodity_code: commodityCode,
        country_of_origin: country,
        metal_info: metalInfo
      });
    }

    return lines;
  }

  function parseMetalContent(text) {
    const metals = [];
    
    if (text.includes('Does not contain any aluminum') || 
        text.includes('Steel or Copper')) {
      return { hasMetals: false, metals: [] };
    }

    const steelMatch = text.match(/Steel content (\d+)%:\s*([\d,]+\.?\d*)\s*kg/i);
    if (steelMatch) {
      const countryMatch = text.match(/Country of Melt & Pour:\s*([A-Z]{2,})/i);
      metals.push({
        type: 'steel',
        percentage: parseInt(steelMatch[1]),
        weight: parseFloat(steelMatch[2].replace(/,/g, '')),
        countryMeltPour: countryMatch ? countryMatch[1] : ''
      });
    }

    const aluminumMatch = text.match(/Aluminum content (\d+)%:\s*([\d,]+\.?\d*)\s*kg/i);
    if (aluminumMatch) {
      const countryMatch = text.match(/Country of Melt & Pour:\s*([A-Z]{2,})/i);
      metals.push({
        type: 'aluminum',
        percentage: parseInt(aluminumMatch[1]),
        weight: parseFloat(aluminumMatch[2].replace(/,/g, '')),
        countryMeltPour: countryMatch ? countryMatch[1] : ''
      });
    }

    const copperMatch = text.match(/Copper content (\d+)%:\s*([\d,]+\.?\d*)\s*kg/i);
    if (copperMatch) {
      metals.push({
        type: 'copper',
        percentage: parseInt(copperMatch[1]),
        weight: parseFloat(copperMatch[2].replace(/,/g, '')),
        countryMeltPour: ''
      });
    }

    return {
      hasMetals: metals.length > 0,
      metals: metals
    };
  }

  function populateInvoiceDropdown() {
    const select = document.getElementById('invoiceSelect');
    select.innerHTML = '<option value="">Select an invoice...</option>';
    invoices.forEach(inv => {
      const opt = document.createElement('option');
      opt.value = inv.invoice_number;
      opt.textContent = `Invoice ${inv.invoice_number} - ${inv.invoice_date} - $${inv.net_amount.toFixed(2)}`;
      select.appendChild(opt);
    });
  }

  function displayInvoice(invoiceNumber) {
    currentInvoice = invoices.find(inv => inv.invoice_number === invoiceNumber);
    if (!currentInvoice) return;

    document.getElementById('statInvoice').textContent = currentInvoice.invoice_number;
    document.getElementById('statDate').value = currentInvoice.invoice_date;
    document.getElementById('statSupplier').value = currentInvoice.supplier;
    document.getElementById('statItems').textContent = currentInvoice.line_items.length;
    document.getElementById('statTotal').value = currentInvoice.net_amount.toFixed(2);
    document.getElementById('statGrossWeight').textContent = currentInvoice.gross_weight ? `${currentInvoice.gross_weight.toFixed(3)} KG` : '-';
    document.getElementById('statNetWeight').textContent = currentInvoice.net_weight ? `${currentInvoice.net_weight.toFixed(3)} KG` : '-';

    updateStats();
    renderTable();

    document.getElementById('controls').style.display = 'flex';
    document.getElementById('stats').style.display = 'grid';
    document.getElementById('tableContainer').style.display = 'block';
  }

  function updateStats() {
    if (!currentInvoice) return;
    const sum = currentInvoice.line_items.reduce((acc, item) => acc + (item.line_total || 0), 0);
    const diff = currentInvoice.net_amount - sum;
    
    document.getElementById('statSum').textContent = `$${sum.toFixed(2)}`;
    document.getElementById('statDiff').textContent = `$${diff.toFixed(2)}`;
    document.getElementById('statDiff').className = 'stat-value ' + (Math.abs(diff) < 0.01 ? 'success' : 'error');
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    currentInvoice.line_items.forEach((item, idx) => {
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><input type="text" class="readonly" value="${item.item_number}" readonly /></td>
        <td><input type="text" value="${item.material_code}" onchange="updateLineItem(${idx}, 'material_code', this.value)" /></td>
        <td><input type="number" value="${item.quantity}" onchange="updateLineItem(${idx}, 'quantity', this.value)" /></td>
        <td><input type="text" value="${item.unit}" onchange="updateLineItem(${idx}, 'unit', this.value)" /></td>
        <td><input type="number" step="0.01" value="${item.unit_price}" onchange="updateLineItem(${idx}, 'unit_price', this.value)" /></td>
        <td><input type="number" step="0.01" value="${item.line_total}" onchange="updateLineItem(${idx}, 'line_total', this.value)" /></td>
        <td><input type="number" step="0.001" value="${item.net_weight || ''}" onchange="updateLineItem(${idx}, 'net_weight', this.value)" /></td>
        <td><input type="text" value="${item.country_of_origin}" onchange="updateLineItem(${idx}, 'country_of_origin', this.value)" /></td>
        <td>${renderMetalBadges(item.metal_info)}</td>
        <td>${renderMetalPercentage(item.metal_info)}</td>
        <td>${renderMetalWeight(item.metal_info)}</td>
        <td>${renderMeltCountry(item.metal_info)}</td>
        <td class="actions">
          <button class="btn-danger" onclick="deleteLineItem(${idx})">Delete</button>
        </td>
      `;
    });
  }

  function renderMetalBadges(metalInfo) {
    if (!metalInfo || !metalInfo.hasMetals) {
      return '<span class="metal-badge metal-none">No Metal</span>';
    }
    return metalInfo.metals.map(m => 
      `<span class="metal-badge metal-${m.type}">${m.type.toUpperCase()}</span>`
    ).join('');
  }

  function renderMetalPercentage(metalInfo) {
    if (!metalInfo || !metalInfo.hasMetals) return '-';
    return metalInfo.metals.map(m => `${m.percentage}%`).join('<br>');
  }

  function renderMetalWeight(metalInfo) {
    if (!metalInfo || !metalInfo.hasMetals) return '-';
    return metalInfo.metals.map(m => `${m.weight} kg`).join('<br>');
  }

  function renderMeltCountry(metalInfo) {
    if (!metalInfo || !metalInfo.hasMetals) return '-';
    return metalInfo.metals.map(m => m.countryMeltPour || '-').join('<br>');
  }

  function updateLineItem(idx, field, value) {
    if (field === 'quantity' || field === 'unit_price' || field === 'line_total' || field === 'net_weight') {
      value = parseFloat(value) || 0;
    }
    currentInvoice.line_items[idx][field] = value;
    
    if (field === 'quantity' || field === 'unit_price') {
      currentInvoice.line_items[idx].line_total = 
        currentInvoice.line_items[idx].quantity * currentInvoice.line_items[idx].unit_price;
      renderTable();
    }
    
    updateStats();
  }

  function deleteLineItem(idx) {
    if (confirm('Delete this line item?')) {
      currentInvoice.line_items.splice(idx, 1);
      renderTable();
      updateStats();
    }
  }

  function updateInvoiceField(field, value) {
    if (!currentInvoice) return;
    currentInvoice[field] = value;
  }

  function updateInvoiceTotal(value) {
    if (!currentInvoice) return;
    currentInvoice.net_amount = parseFloat(value) || 0;
    updateStats();
  }

  function showAlert(message, type) {
    const alert = document.getElementById('alert');
    alert.textContent = message;
    alert.className = 'alert';
    alert.style.display = 'block';
    alert.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
    alert.style.color = type === 'success' ? '#155724' : '#721c24';
    alert.style.borderLeft = `4px solid ${type === 'success' ? '#28a745' : '#dc3545'}`;
  }

  function resetUpload() {
    invoices = [];
    currentInvoice = null;
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('controls').style.display = 'none';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('tableContainer').style.display = 'none';
    document.getElementById('alert').style.display = 'none';
    document.getElementById('fileInput').value = '';
  }

  function debugDumpData() {
    console.log('=== DEBUG DATA DUMP ===');
    console.log('All Invoices:', JSON.parse(JSON.stringify(invoices)));
    console.log('Current Invoice:', JSON.parse(JSON.stringify(currentInvoice)));
    console.log('Database:', globalDatabase);
    alert('Debug data dumped to console (F12)');
  }

  function exportToDescartes() {
    if (!currentInvoice) {
      alert('No invoice selected');
      return;
    }

    const supplierMid = 'EISEN';
    const rows = [];

    currentInvoice.line_items.forEach(item => {
      const partNumber = item.material_code;
      
      // Calculate net weight if not present
      let itemNetWeight = item.net_weight;
      if (!itemNetWeight && currentInvoice.net_weight && currentInvoice.net_amount) {
        // Get total of lines that already have net weight
        const totalAssignedWeight = currentInvoice.line_items.reduce((sum, li) => {
          return sum + (li.net_weight || 0);
        }, 0);
        
        // Remaining weight to distribute
        const remainingWeight = currentInvoice.net_weight - totalAssignedWeight;
        
        // Calculate total of lines without net weight
        const linesWithoutWeight = currentInvoice.line_items.filter(li => !li.net_weight);
        const totalWithoutWeight = linesWithoutWeight.reduce((sum, li) => sum + (li.line_total || 0), 0);
        
        // Calculate proportional weight for this line
        if (totalWithoutWeight > 0 && remainingWeight > 0) {
          itemNetWeight = (item.line_total / totalWithoutWeight) * remainingWeight;
        }
      }

      const baseRow = buildBaseRow(item, supplierMid, currentInvoice.invoice_date, currentInvoice.supplier);
      baseRow['NetWeight'] = itemNetWeight ? itemNetWeight.toFixed(3) : '';
      fillTariffs(baseRow, partNumber, itemNetWeight || '');
      rows.push(baseRow);

      if (item.metal_info && item.metal_info.hasMetals) {
        item.metal_info.metals.forEach(metal => {
          const metalRow = buildMetalRow(item, supplierMid, metal);
          rows.push(metalRow);
        });
      }
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Invoice Data');

    const filename = `Descartes_CI_${currentInvoice.invoice_number}_${Date.now()}.xlsx`;
    XLSX.writeFile(wb, filename);

    showAlert(`‚úì Exported ${rows.length} rows to ${filename}`, 'success');
  }

  function buildBaseRow(item, supplierMid, invoiceDate, supplier) {
    return {
      'SupplierName': supplier || 'Eisenmann GmbH',
      'InvoiceNumber': currentInvoice.invoice_number,
      'InvoiceDate': invoiceDate || '',
      'LineNumber': item.item_number || '',
      'BuyerPartNumber': item.material_code || '',
      'SupplierPartNumber': item.material_code || '',
      'Description': item.description || '',
      'Quantity': item.quantity || '',
      'UnitOfMeasure': item.unit || 'PC',
      'UnitPrice': item.unit_price || '',
      'ItemTotal': item.line_total || '',
      'CurrencyCode': 'USD',
      'ExchangeRate': '',
      'CountryOfOrigin': item.country_of_origin || 'DE',
      'CountryOfExport': 'DE',
      'DateOfExport': '',
      'PortOfLading': '',
      'RelatedParty': '',
      'PO_Number': '',
      'PO_Date': '',
      'GrossWeight': '',
      'GrossWeightUnit': '',
      'NetWeight': item.net_weight || '',
      'TariffNumber': '',
      'TariffDescription': '',
      'Quantity1': '',
      'UnitOfMeasure1': '',
      'Quantity2': '',
      'UnitOfMeasure2': '',
      'Quantity3': '',
      'UnitOfMeasure3': '',
      'PrimarySPI': '',
      'SecondarySPI': '',
      'DeliverTo': '',
      'SoldTo': '',
      'SellerMID': '',
      'ShipperMID': '',
      'EntryDate': '',
      'ArrivalDate': '',
      'Carrier': '',
      'Vessel': '',
      'Voyage': '',
      'PortOfEntry': '',
      'PortOfUnloading': '',
      'LocationCode': '',
      'TotalCharges': '',
      'BillOfLadingNumber': '',
      'Container': '',
      'SecondaryTariffNumber': '',
      'SecondaryTariffdescription': '',
      'Secondary Quantity1': '',
      'Secondaryunitofmeasure1': '',
      'secondaryquantity2': '',
      'secondaryunitofmeasure2': '',
      'secondaryquantity3': '',
      'secondaryunitofmeasure3': '',
      'secondaryvalue': '',
      'FTZStatus': '',
      'FTZPrivilegedDate\u00a0': '',
      'ThirdTariffNumber': '',
      'ThirdTariffDescription': '',
      'ThirdTariffQuantity1': '',
      'ThirdTariffUnitofMeasure1': '',
      'ThirdTariffQuantity2': '',
      'ThirdTariffUnitofMeasure2': '',
      'ThirdTariffQuantity3': '',
      'ThirdTariffUnitofMeasure3': '',
      'Third Value': '',
      '4TariffNumber': '',
      '4TariffDescription': '',
      '4TariffQuantity1': '',
      '4TariffUnitofMeasure1': '',
      '4TariffQuantity2': '',
      '4TariffUnitofMeasure2': '',
      '4TariffQuantity3': '',
      '4TariffUnitofMeasure3': '',
      '4 Value': '',
      '5TariffNumber': '',
      '5TariffDescription': '',
      '5TariffQuantity1': '',
      '5TariffUnitofMeasure1': '',
      '5TariffQuantity2': '',
      '5TariffUnitofMeasure2': '',
      '5TariffQuantity3': '',
      '5TariffUnitofMeasure3': '',
      '5 Value': ''
    };
  }

  function fillTariffs(row, partNumber, netWeight) {
    const tariffs = lookupTariffsByPart(partNumber);
    const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];

    tariffs.forEach((tariff, idx) => {
      if (idx < tariffFields.length) {
        row[tariffFields[idx]] = tariff;
        
        const startsWithExempt = String(tariff).startsWith('98') || String(tariff).startsWith('99');
        if (!startsWithExempt) {
          const uomInfo = lookupHtsUom(tariff);
          
          if (idx === 0) {
            row['Quantity1'] = netWeight;
            row['UnitOfMeasure1'] = uomInfo.uom1;
            if (uomInfo.uom2) {
              row['Quantity2'] = netWeight;
              row['UnitOfMeasure2'] = uomInfo.uom2;
            }
          } else if (idx === 1) {
            row['Secondary Quantity1'] = netWeight;
            row['Secondaryunitofmeasure1'] = uomInfo.uom1;
            if (uomInfo.uom2) {
              row['secondaryquantity2'] = netWeight;
              row['secondaryunitofmeasure2'] = uomInfo.uom2;
            }
          } else if (idx === 2) {
            row['ThirdTariffQuantity1'] = netWeight;
            row['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
            if (uomInfo.uom2) {
              row['ThirdTariffQuantity2'] = netWeight;
              row['ThirdTariffUnitofMeasure2'] = uomInfo.uom2;
            }
          } else if (idx === 3) {
            row['4TariffQuantity1'] = netWeight;
            row['4TariffUnitofMeasure1'] = uomInfo.uom1;
            if (uomInfo.uom2) {
              row['4TariffQuantity2'] = netWeight;
              row['4TariffUnitofMeasure2'] = uomInfo.uom2;
            }
          } else if (idx === 4) {
            row['5TariffQuantity1'] = netWeight;
            row['5TariffUnitofMeasure1'] = uomInfo.uom1;
            if (uomInfo.uom2) {
              row['5TariffQuantity2'] = netWeight;
              row['5TariffUnitofMeasure2'] = uomInfo.uom2;
            }
          }
        }
      }
    });

    // Special handling for ALL STEEL, ALL COPPER, ALL ALUMINUM parts
    const partUpper = String(partNumber).toUpperCase();
    if (partUpper.startsWith('ALL STEEL') || partUpper.startsWith('ALL COPPER') || partUpper.startsWith('ALL ALUMINUM')) {
      if (tariffs.length > 2 && tariffs[2]) {
        row['ThirdTariffQuantity1'] = netWeight;
      }
      row['TariffNumber'] = '';
      row['ThirdTariffUnitofMeasure1'] = '';
      row['Secondary Quantity1'] = netWeight;
    }
  }

  function buildMetalRow(item, supplierMid, metal) {
    const metalRow = buildBaseRow(item, supplierMid, '', '');
    
    const metalType = metal.type.toLowerCase();
    if (metalType === 'steel') {
      metalRow['BuyerPartNumber'] = 'STEEL EXCL';
      metalRow['SupplierPartNumber'] = 'STEEL EXCL';
      metalRow['TariffNumber'] = '99030133';
      metalRow['SecondaryTariffNumber'] = '99038191';
    } else if (metalType === 'aluminum') {
      metalRow['BuyerPartNumber'] = 'ALUM EXCL';
      metalRow['SupplierPartNumber'] = 'ALUM EXCL';
      metalRow['TariffNumber'] = '99030133';
      metalRow['SecondaryTariffNumber'] = '99038508';
    } else if (metalType === 'copper') {
      metalRow['BuyerPartNumber'] = 'COPPER EXCL';
      metalRow['SupplierPartNumber'] = 'COPPER EXCL';
      metalRow['TariffNumber'] = '99030133';
    }
    
    const metalWeight = String(metal.weight || '');
    metalRow['NetWeight'] = metalWeight;
    metalRow['Quantity'] = metalWeight;
    metalRow['Secondary Quantity1'] = metalWeight;
    metalRow['Secondaryunitofmeasure1'] = 'KG';
    metalRow['ItemTotal'] = '0';
    metalRow['UnitPrice'] = '0';
    
    if (metal.countryMeltPour) {
      metalRow['CountryOfOrigin'] = metal.countryMeltPour;
    }
    
    return metalRow;
  }
</script>
</body>
</html>
