<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Eisenmann Invoice PDF Parser</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:#f5f7fa;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;border-radius:8px 8px 0 0}
    .header h1{margin-bottom:8px}
    .upload-section{padding:40px;text-align:center}
    .upload-box{border:3px dashed #cbd5e0;border-radius:8px;padding:40px;cursor:pointer;transition:.3s}
    .upload-box:hover{border-color:#667eea;background:#f7fafc}
    .upload-box.dragover{border-color:#667eea;background:#e6f0ff}
    #fileInput{display:none}
    .loading{padding:40px;text-align:center;display:none}
    .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .controls{padding:20px;background:#f8f9fa;border-bottom:1px solid #dee2e6;display:none;position:sticky;top:0;z-index:100;align-items:center;gap:10px;flex-wrap:wrap}
    .controls select{padding:10px;border:1px solid #ced4da;border-radius:4px;font-size:14px;min-width:260px}
    .controls button{padding:10px 20px;border:none;border-radius:4px;font-weight:600;cursor:pointer}
    .btn-success{background:#28a745;color:#fff}.btn-success:hover{background:#218838}
    .btn-primary{background:#007bff;color:#fff}.btn-primary:hover{background:#0056b3}
    .btn-danger{background:#dc3545;color:#fff}.btn-danger:hover{background:#c82333}
    .btn-light{background:#f8f9fa;color:#212529;border:1px solid #ced4da}
    .inline-help{font-size:12px;color:#6c757d;margin-left:8px}
    .db-banner{padding:12px 20px;background:#fff3cd;border-bottom:1px solid #ffc107;font-size:13px;display:flex;align-items:center;gap:10px}
    .db-status{font-weight:600}
    .db-status.loading{color:#856404}
    .db-status.loaded{color:#155724}
    .db-status.offline{color:#6c757d}
    .db-btn{padding:4px 10px;border-radius:4px;border:1px solid #856404;background:#fff;font-size:11px;cursor:pointer}
    .stats{padding:20px;display:none;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;background:#fff3cd}
    .stat{padding:15px;background:#fff;border-radius:4px;border-left:4px solid #ffc107}
    .stat-label{font-size:11px;color:#6c757d;text-transform:uppercase;margin-bottom:5px}
    .stat-value{font-size:20px;font-weight:700}
    .stat-value.error{color:#dc3545}.stat-value.success{color:#28a745}
    .stat input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:16px;font-weight:bold}
    .stat.editable{border-left-color:#007bff}
    .table-container{padding:20px;display:none}
    .table-header-wrapper{background:#343a40;overflow:auto}
    .table-header-wrapper::-webkit-scrollbar{display:none}
    .table-header-wrapper{scrollbar-width:none}
    .table-header{min-width:1532px}
    .table-header table{width:100%;border-collapse:collapse}
    .table-header th{background:#343a40;color:#fff;padding:8px;text-align:left;font-weight:600;font-size:13px;border:none}
    .table-body-wrapper{max-height:560px;overflow:auto}
    .table-body{min-width:1532px}
    .table-body table{width:100%;border-collapse:collapse}
    .table-body td{padding:6px 6px;border-bottom:1px solid #dee2e6;background:#fff}
    .table-body tr:hover td{background:#f8f9fa}
    .table-body td input{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px}
    .table-body td select{width:100%;padding:6px;border:1px solid #ced4da;border-radius:3px;font-size:13px;background:#fff}
    .table-body td input:focus,.table-body td select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 2px rgba(102,126,234,.15)}
    .readonly{background:#e9ecef!important}
    .actions{text-align:center;white-space:nowrap}
    .actions button{padding:4px 8px;font-size:11px;margin:0 2px}
    .alert{margin:0 20px 20px;border-radius:4px;padding:10px 14px;font-size:13px;display:none}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .table-header table,.table-body table{table-layout:fixed}
    .table-header th:nth-child(1),.table-body td:nth-child(1){width:52px!important}
    .table-header th:nth-child(2),.table-body td:nth-child(2){width:190px!important}
    .table-header th:nth-child(3),.table-body td:nth-child(3){width:80px!important}
    .table-header th:nth-child(4),.table-body td:nth-child(4){width:60px!important}
    .table-header th:nth-child(5),.table-body td:nth-child(5){width:110px!important}
    .table-header th:nth-child(6),.table-body td:nth-child(6){width:110px!important}
    .table-header th:nth-child(7),.table-body td:nth-child(7){width:110px!important}
    .table-header th:nth-child(8),.table-body td:nth-child(8){width:110px!important}
    .table-header th:nth-child(9),.table-body td:nth-child(9){width:100px!important}
    .table-header th:nth-child(10),.table-body td:nth-child(10){width:80px!important}
    .table-header th:nth-child(11),.table-body td:nth-child(11){width:100px!important}
    .table-header th:nth-child(12),.table-body td:nth-child(12){width:120px!important}
    .table-header th:nth-child(13),.table-body td:nth-child(13){width:110px!important}
    .metal-badge{display:inline-block;padding:2px 6px;margin:2px;border-radius:3px;font-size:11px;font-weight:600}
    .metal-steel{background:#c0c0c0;color:#333}
    .metal-copper{background:#b87333;color:#fff}
    .metal-aluminum{background:#a8a9ad;color:#fff}
    .metal-none{background:#d4edda;color:#155724;padding:4px 8px}
    .metal-info{font-size:11px;line-height:1.4}
    .country-melt{font-style:italic;color:#6c757d;font-size:10px;display:block;margin-top:2px}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üìÑ Eisenmann Invoice PDF Parser</h1>
    <p>Parse Eisenmann customs invoices into editable line items and export to Descartes CI template.</p>
  </div>

  <div class="db-banner">
    <span id="dbStatus" class="db-status loading">DB: not loaded</span>
    <span id="dbInfo">Will try to load updated_eisenmann_db.xlsx from GitHub...</span>
    <button id="retryDbBtn" class="db-btn">Retry DB</button>
    <button id="offlineDbBtn" class="db-btn">Work offline</button>
  </div>

  <div class="upload-section" id="uploadSection">
    <div class="upload-box" id="uploadBox">
      <h2>üì§ Upload Eisenmann PDF</h2>
      <p style="margin-top:10px;color:#6c757d">Click or drag &amp; drop your multi-invoice PDF here</p>
      <input type="file" id="fileInput" accept=".pdf,application/pdf" />
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div><strong>Processing PDF...</strong></div>
  </div>

  <div class="alert" id="alert"></div>

  <div class="controls" id="controls">
    <select id="invoiceSelect"><option value="">Select an invoice...</option></select>
    <button class="btn-success" onclick="exportToDescartes()">üìä Export to Descartes CI Template</button>
    <button class="btn-primary" onclick="resetUpload()">üì§ New Upload</button>
    <button class="btn-light" onclick="debugDumpData()">üêõ Debug: Dump Data</button>
    <span class="inline-help">Use Tab / Shift+Tab to move across cells. Edit invoice totals/dates at the top.</span>
  </div>

  <div class="stats" id="stats">
    <div class="stat">
      <div class="stat-label">Invoice Number</div>
      <div class="stat-value" id="statInvoice">-</div>
    </div>
    <div class="stat editable">
      <div class="stat-label">Invoice Date (Editable)</div>
      <input autocomplete="off" type="text" id="statDate" placeholder="MM/DD/YYYY"
             onchange="updateInvoiceField('invoice_date', this.value)">
    </div>
    <div class="stat editable">
      <div class="stat-label">Supplier (Editable)</div>
      <input autocomplete="off" type="text" id="statSupplier" placeholder="Supplier name"
             onchange="updateInvoiceField('supplier', this.value)">
    </div>
    <div class="stat">
      <div class="stat-label">Total Line Items</div>
      <div class="stat-value" id="statItems">0</div>
    </div>
    <div class="stat editable">
      <div class="stat-label">Invoice Total (Editable)</div>
      <input autocomplete="off" type="number" step="0.01" id="statTotal" placeholder="0.00"
             onchange="updateInvoiceTotal(this.value)">
    </div>
    <div class="stat">
      <div class="stat-label">Line Items Sum</div>
      <div class="stat-value" id="statSum">$0.00</div>
    </div>
    <div class="stat">
      <div class="stat-label">Difference</div>
      <div class="stat-value" id="statDiff">$0.00</div>
    </div>
  </div>

  <div class="table-container" id="tableContainer">
    <div class="table-header-wrapper">
      <div class="table-header">
        <table>
          <thead>
          <tr>
            <th>Pos</th>
            <th>Material / Part #</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Unit Price</th>
            <th>Line Total</th>
            <th>Net Weight</th>
            <th>Country</th>
            <th>Metal Type</th>
            <th title="Metal percentage (typically 100)">Metal %</th>
            <th>Metal Wt (kg)</th>
            <th>Melt Country</th>
            <th>Actions</th>
          </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="table-body-wrapper">
      <div class="table-body">
        <table>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // ========= PDF.JS CONFIG =========
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // ========= GLOBAL STATE =========
  let allData = [];       // all line items for all invoices
  let currentInvoice = '';
  let invoiceOrder = [];
  let uploadedPdfName = '';

  // Database state
  let eisenmannDb = [];
  let htsCodesDb = [];
  let supplierMidDb = [];

  const uploadBox   = document.getElementById('uploadBox');
  const fileInput   = document.getElementById('fileInput');
  const loadingPane = document.getElementById('loading');
  const uploadSec   = document.getElementById('uploadSection');
  const alertBox    = document.getElementById('alert');
  const controls    = document.getElementById('controls');
  const stats       = document.getElementById('stats');
  const tableCont   = document.getElementById('tableContainer');
  const tbody       = document.getElementById('tableBody');
  const invoiceSelect = document.getElementById('invoiceSelect');

  // ========= DATABASE LOADING =========
  const GITHUB_CONFIG = {
    owner: 'iffinc-ga',
    repo: 'all_in_one_manki',
    branch: 'main',
    filePath: 'updated_eisenmann_db.xlsx'
  };

  const dbStatusEl = document.getElementById('dbStatus');
  const dbInfo = document.getElementById('dbInfo');
  const retryDbBtn = document.getElementById('retryDbBtn');
  const offlineDbBtn = document.getElementById('offlineDbBtn');

  function setDbBanner(state, msg, info) {
    if (!dbStatusEl) return;
    let cls = 'db-status';
    if (state === 'loading') cls += ' loading';
    else if (state === 'loaded') cls += ' loaded';
    else if (state === 'offline') cls += ' offline';
    dbStatusEl.className = cls;
    dbStatusEl.textContent = msg;
    if (dbInfo && info != null) dbInfo.textContent = info;
  }

  function abortableFetch(url, timeoutMs = 8000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeoutMs);
    return fetch(url, { signal: ctrl.signal }).finally(() => clearTimeout(t));
  }

  async function fetchAndReadWorkbook(url, useAbort) {
    const res = useAbort ? await abortableFetch(url, 8000) : await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf, { type: 'array' });
  }

  async function hydrateDbFromWorkbook(workbook) {
    // Load Eisenmann sheet
    const eisenmannSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('eisenmann')) || workbook.SheetNames[0];
    eisenmannDb = XLSX.utils.sheet_to_json(workbook.Sheets[eisenmannSheet], { defval: '' });
    console.log(`[DB] Loaded ${eisenmannSheet}: ${eisenmannDb.length} rows`);

    // Load HTS codes sheet if exists
    const htsSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('hts'));
    if (htsSheet) {
      htsCodesDb = XLSX.utils.sheet_to_json(workbook.Sheets[htsSheet], { defval: '' });
      console.log(`[DB] Loaded ${htsSheet}: ${htsCodesDb.length} rows`);
    }

    // Load supplier MID sheet if exists
    const midSheet = workbook.SheetNames.find(n => n.toLowerCase().includes('mid'));
    if (midSheet) {
      supplierMidDb = XLSX.utils.sheet_to_json(workbook.Sheets[midSheet], { defval: '' });
      console.log(`[DB] Loaded ${midSheet}: ${supplierMidDb.length} rows`);
    }

    setDbBanner('loaded', 'DB: Loaded successfully', `${eisenmannDb.length} parts`);
  }

  async function tryLoadDbFromGitHub() {
    try {
      setDbBanner('loading', 'DB: Loading from GitHub...', '');
      const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.filePath}`;
      const wb = await fetchAndReadWorkbook(rawUrl, true);
      await hydrateDbFromWorkbook(wb);
    } catch (err) {
      console.error('[DB] GitHub load failed:', err);
      setDbBanner('offline', 'DB: Failed to load', 'Working offline without database');
    }
  }

  retryDbBtn.addEventListener('click', tryLoadDbFromGitHub);
  offlineDbBtn.addEventListener('click', () => {
    setDbBanner('offline', 'DB: Working offline', 'Database features disabled');
  });

  // Try to load DB on startup
  tryLoadDbFromGitHub();

  // ========= DATABASE LOOKUP FUNCTIONS =========
  function lookupTariffsByPart(partNumber) {
    if (!eisenmannDb.length) return [];
    const upper = String(partNumber).toUpperCase().trim();
    const row = eisenmannDb.find(r => String(r['Part Number'] || '').toUpperCase().trim() === upper);
    if (!row) return [];
    
    const tariffs = [];
    for (let i = 1; i <= 5; i++) {
      const col = `Tariff${i}`;
      const val = String(row[col] || '').trim();
      if (val && val !== '0') tariffs.push(val);
    }
    return tariffs;
  }

  function lookupHtsUom(htsCode) {
    if (!htsCodesDb.length) return { uom1: 'KG', uom2: '' };
    const code = String(htsCode).trim();
    const row = htsCodesDb.find(r => String(r['HTS Code'] || '').trim() === code);
    if (!row) return { uom1: 'KG', uom2: '' };
    
    return {
      uom1: String(row['UOM1'] || 'KG').trim(),
      uom2: String(row['UOM2'] || '').trim()
    };
  }

  function lookupSupplierMid(supplierName) {
    if (!supplierMidDb.length) return '';
    const upper = String(supplierName).toUpperCase().trim();
    const row = supplierMidDb.find(r => String(r['Supplier'] || '').toUpperCase().trim().includes(upper));
    return row ? String(row['MID'] || '').trim() : '';
  }

  // ========= UPLOAD HANDLERS (unchanged) =========
  uploadBox.addEventListener('click', () => fileInput.click());
  uploadBox.addEventListener('dragover', e => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
  });
  uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
  uploadBox.addEventListener('drop', e => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      fileInput.files = e.dataTransfer.files;
      handleFileSelect({ target: fileInput });
    }
  });

  fileInput.addEventListener('change', handleFileSelect);

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    const fname = file.name.replace(/\.pdf$/i, '');
    uploadedPdfName = fname;
    parsePDF(file);
  }

  function showAlert(msg, type = 'info') {
    alertBox.textContent = msg;
    alertBox.className = 'alert';
    if (type === 'error') alertBox.style.background = '#f8d7da';
    else if (type === 'success') alertBox.style.background = '#d4edda';
    else alertBox.style.background = '#d1ecf1';
    alertBox.style.display = 'block';
    setTimeout(() => { alertBox.style.display = 'none'; }, 5000);
  }

  // ========= PDF PARSING (unchanged) =========
  async function parsePDF(file) {
    uploadSec.style.display = 'none';
    loadingPane.style.display = 'block';
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      parseInvoices(fullText);
    } catch (err) {
      console.error('PDF parse error:', err);
      showAlert('Failed to parse PDF: ' + err.message, 'error');
      uploadSec.style.display = 'block';
      loadingPane.style.display = 'none';
    }
  }

  function parseInvoices(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    const invoicePattern = /Customs Invoice\s+([\w\-\/]+)/gi;
    const matches = [];
    let m;
    while ((m = invoicePattern.exec(text)) !== null) {
      matches.push({ index: m.index, number: m[1] });
    }

    if (!matches.length) {
      showAlert('No "Customs Invoice" headers found.', 'error');
      uploadSec.style.display = 'block';
      loadingPane.style.display = 'none';
      return;
    }

    allData = [];
    invoiceOrder = [];

    for (let i = 0; i < matches.length; i++) {
      const invNum = matches[i].number;
      invoiceOrder.push(invNum);
      const startIdx = matches[i].index;
      const endIdx = (i + 1 < matches.length) ? matches[i + 1].index : text.length;
      const chunk = text.substring(startIdx, endIdx);
      parseOneInvoice(chunk, invNum);
    }

    if (!allData.length) {
      showAlert('No line items parsed.', 'error');
      uploadSec.style.display = 'block';
      loadingPane.style.display = 'none';
      return;
    }

    loadingPane.style.display = 'none';
    controls.style.display = 'flex';
    stats.style.display = 'grid';
    tableCont.style.display = 'block';

    invoiceSelect.innerHTML = '<option value="">Select an invoice...</option>';
    invoiceOrder.forEach(inv => {
      const opt = document.createElement('option');
      opt.value = inv;
      opt.textContent = inv;
      invoiceSelect.appendChild(opt);
    });

    currentInvoice = invoiceOrder[0];
    invoiceSelect.value = currentInvoice;
    loadInvoiceData();
    showAlert(`Parsed ${allData.length} line items from ${invoiceOrder.length} invoice(s).`, 'success');
  }

  function parseOneInvoice(chunk, invNum) {
    const dateMatch = chunk.match(/Date\s*[:]\s*(\d{2}\.\d{2}\.\d{4})/);
    let invDate = '';
    if (dateMatch) {
      const [d, m, y] = dateMatch[1].split('.');
      invDate = `${m}/${d}/${y}`;
    }

    const totalMatch = chunk.match(/Total\s+Value\s+([\d,]+\.\d+)/);
    const invTotal = totalMatch ? totalMatch[1].replace(/,/g, '') : '';

    const supplierMatch = chunk.match(/Exporter\/Manufacturer\s*[:]\s*([^\n]+)/);
    const supplier = supplierMatch ? supplierMatch[1].trim() : 'Eisenmann GmbH';

    const posPattern = /(\d+)\s+([\w\d\s\-\/\.\(\)]+?)\s+(\d+[\d\s,]*)\s+(ST|PC|Pcs|EA)\s+([\d,]+\.\d+)\s+([\d,]+\.\d+)\s+([\d,]+\.\d+)\s+DE/g;
    let match;
    while ((match = posPattern.exec(chunk)) !== null) {
      const position = match[1];
      let partNum = match[2].trim();
      const quantity = match[3].replace(/\s/g, '');
      const unit = match[4];
      const unitPrice = match[5].replace(/,/g, '');
      const lineTotal = match[6].replace(/,/g, '');
      const netWeight = match[7].replace(/,/g, '');

      const metalContent = extractMetalContent(chunk, position);

      allData.push({
        invoice_number: invNum,
        invoice_date: invDate,
        invoice_total: invTotal,
        supplier: supplier,
        position: position,
        part_number: partNum,
        quantity: quantity,
        unit: unit,
        unit_price: unitPrice,
        line_total: lineTotal,
        net_weight: netWeight,
        country_of_origin: 'DE',
        hts_code: '',
        metal_type: metalContent.metals.length > 0 ? metalContent.metals.map(m => m.type).join(', ') : '',
        metal_percentage: metalContent.metals.length > 0 ? metalContent.metals[0].percentage : '',
        metal_weight: metalContent.metals.length > 0 ? metalContent.metals[0].weight : '',
        metal_country: metalContent.metals.length > 0 ? metalContent.metals[0].country : '',
        metal_content: metalContent
      });
    }
  }

  function extractMetalContent(text, position) {
    const result = { hasMetals: false, metals: [], noContent: false };
    const posStr = 'Pos. ' + position;
    const posIdx = text.indexOf(posStr);
    if (posIdx === -1) return result;

    const nextPosMatch = text.substring(posIdx + 10).match(/Pos\.\s+\d+/);
    const endIdx = nextPosMatch ? posIdx + 10 + nextPosMatch.index : text.length;
    const section = text.substring(posIdx, endIdx);

    if (/Stainless\s+steel/i.test(section) || /Steel\s+Content/i.test(section)) {
      result.hasMetals = true;
      const steelMatch = section.match(/Steel\s+Content[:\s]*([\d,]+\.?\d*)\s*kg[^\d]*([\d,]+\.?\d*)?\s*%/i);
      if (steelMatch) {
        const weight = steelMatch[1].replace(/,/g, '');
        const percent = steelMatch[2] ? steelMatch[2].replace(/,/g, '') : '100';
        const countryMatch = section.match(/Country\s+of\s+Melting\s*[:\s]*([A-Z]{2})/i);
        const country = countryMatch ? countryMatch[1] : '';
        result.metals.push({ type: 'Steel', weight: weight, percentage: percent, country: country });
      }
    }

    if (/Aluminum/i.test(section)) {
      const alumMatch = section.match(/Aluminum\s+Content[:\s]*([\d,]+\.?\d*)\s*kg[^\d]*([\d,]+\.?\d*)?\s*%/i);
      if (alumMatch) {
        result.hasMetals = true;
        const weight = alumMatch[1].replace(/,/g, '');
        const percent = alumMatch[2] ? alumMatch[2].replace(/,/g, '') : '100';
        const countryMatch = section.match(/Country\s+of\s+Melting\s*[:\s]*([A-Z]{2})/i);
        const country = countryMatch ? countryMatch[1] : '';
        result.metals.push({ type: 'Aluminum', weight: weight, percentage: percent, country: country });
      }
    }

    if (/Copper/i.test(section)) {
      const copperMatch = section.match(/Copper\s+Content[:\s]*([\d,]+\.?\d*)\s*kg[^\d]*([\d,]+\.?\d*)?\s*%/i);
      if (copperMatch) {
        result.hasMetals = true;
        const weight = copperMatch[1].replace(/,/g, '');
        const percent = copperMatch[2] ? copperMatch[2].replace(/,/g, '') : '100';
        const countryMatch = section.match(/Country\s+of\s+Melting\s*[:\s]*([A-Z]{2})/i);
        const country = countryMatch ? countryMatch[1] : '';
        result.metals.push({ type: 'Copper', weight: weight, percentage: percent, country: country });
      }
    }

    if (!result.hasMetals && /No\s+(steel|aluminum|copper)\s+content/i.test(section)) {
      result.noContent = true;
    }

    return result;
  }

  // ========= TABLE RENDERING (unchanged) =========
  invoiceSelect.addEventListener('change', e => {
    currentInvoice = e.target.value;
    if (currentInvoice) loadInvoiceData();
  });

  function loadInvoiceData() {
    const rows = allData.filter(r => r.invoice_number === currentInvoice);
    tbody.innerHTML = '';

    rows.forEach((item, localIdx) => {
      const globalIdx = allData.indexOf(item);
      const tr = document.createElement('tr');

      function makeCell(field, readonly = false) {
        const td = document.createElement('td');
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = item[field] || '';
        inp.dataset.index = globalIdx;
        inp.dataset.field = field;
        if (readonly) {
          inp.className = 'readonly';
          inp.readOnly = true;
        }
        inp.addEventListener('change', onCellChange);
        td.appendChild(inp);
        return td;
      }

      tr.appendChild(makeCell('position', true));
      tr.appendChild(makeCell('part_number'));
      tr.appendChild(makeCell('quantity'));
      tr.appendChild(makeCell('unit'));
      tr.appendChild(makeCell('unit_price'));
      tr.appendChild(makeCell('line_total'));
      tr.appendChild(makeCell('net_weight'));
      tr.appendChild(makeCell('country_of_origin'));

      const tdMetal = document.createElement('td');
      const metalContent = item.metal_content || { hasMetals: false, metals: [], noContent: false };
      if (metalContent.noContent) {
        tdMetal.innerHTML = '<div class="metal-badge metal-none">No Content</div>';
      } else if (metalContent.hasMetals && metalContent.metals.length > 0) {
        metalContent.metals.forEach(m => {
          const badge = document.createElement('span');
          badge.className = 'metal-badge';
          if (m.type === 'Steel') badge.classList.add('metal-steel');
          else if (m.type === 'Aluminum') badge.classList.add('metal-aluminum');
          else if (m.type === 'Copper') badge.classList.add('metal-copper');
          badge.textContent = m.type;
          tdMetal.appendChild(badge);
        });
      } else {
        tdMetal.innerHTML = '<div class="metal-info">-</div>';
      }
      tr.appendChild(tdMetal);

      tr.appendChild(makeCell('metal_percentage'));
      tr.appendChild(makeCell('metal_weight'));
      tr.appendChild(makeCell('metal_country'));

      const tdAct = document.createElement('td');
      tdAct.className = 'actions';
      const btnAdd = document.createElement('button');
      btnAdd.textContent = '+ Below';
      btnAdd.className = 'btn-light';
      btnAdd.addEventListener('click', () => addRowBelow(globalIdx));
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Delete';
      btnDel.className = 'btn-danger';
      btnDel.addEventListener('click', () => deleteRow(globalIdx));
      tdAct.appendChild(btnAdd);
      tdAct.appendChild(btnDel);
      tr.appendChild(tdAct);

      tbody.appendChild(tr);
    });

    updateStats();
  }

  function onCellChange(e) {
    const idx = parseInt(e.target.dataset.index, 10);
    const field = e.target.dataset.field;
    if (Number.isNaN(idx) || !field) return;
    allData[idx][field] = e.target.value;
    updateStats();
  }

  function updateStats() {
    const rows = allData.filter(r => r.invoice_number === currentInvoice);

    const statInvoice  = document.getElementById('statInvoice');
    const statDate     = document.getElementById('statDate');
    const statSupplier = document.getElementById('statSupplier');
    const statItems    = document.getElementById('statItems');
    const statTotal    = document.getElementById('statTotal');
    const statSum      = document.getElementById('statSum');
    const statDiff     = document.getElementById('statDiff');

    statInvoice.textContent = currentInvoice || '-';

    if (rows.length) {
      statDate.value     = rows[0].invoice_date || '';
      statSupplier.value = rows[0].supplier || 'Eisenmann GmbH';
      statItems.textContent = rows.length;
      statTotal.value    = rows[0].invoice_total || '';
    } else {
      statDate.value = '';
      statSupplier.value = '';
      statItems.textContent = '0';
      statTotal.value = '';
    }

    let sum = 0;
    rows.forEach(r => {
      const v = parseFloatSafe(r.line_total);
      if (!isNaN(v)) sum += v;
    });
    statSum.textContent = '$' + sum.toFixed(2);

    let diff = 0;
    const invTotal = parseFloatSafe(rows[0]?.invoice_total || '');
    if (!isNaN(invTotal)) diff = invTotal - sum;

    statDiff.textContent = '$' + diff.toFixed(2);
    statDiff.classList.remove('success','error');
    if (!isNaN(invTotal)) {
      if (Math.abs(diff) < 0.01) statDiff.classList.add('success');
      else statDiff.classList.add('error');
    }
  }

  function parseFloatSafe(val) {
    if (!val) return NaN;
    const s = String(val).replace(/,/g, '').trim();
    return s ? parseFloat(s) : NaN;
  }

  function updateInvoiceField(field, value) {
    allData.forEach(r => {
      if (r.invoice_number === currentInvoice) {
        r[field] = value;
      }
    });
    updateStats();
  }

  function updateInvoiceTotal(value) {
    updateInvoiceField('invoice_total', value);
  }

  function addRowBelow(globalIdx) {
    const base = allData[globalIdx];
    if (!base) return;
    const newRow = {
      invoice_number: base.invoice_number,
      invoice_date: base.invoice_date,
      invoice_total: base.invoice_total,
      supplier: base.supplier,
      position: '',
      part_number: '',
      quantity: '',
      unit: '',
      unit_price: '',
      line_total: '',
      net_weight: '',
      country_of_origin: base.country_of_origin || '',
      hts_code: base.hts_code || '',
      metal_type: '',
      metal_percentage: '',
      metal_weight: '',
      metal_country: '',
      metal_content: { hasMetals: false, metals: [], noContent: false }
    };
    allData.splice(globalIdx + 1, 0, newRow);
    loadInvoiceData();
  }

  function deleteRow(globalIdx) {
    if (globalIdx < 0 || globalIdx >= allData.length) return;
    allData.splice(globalIdx, 1);
    loadInvoiceData();
  }

  function resetUpload() {
    allData = [];
    invoiceOrder = [];
    currentInvoice = '';
    uploadedPdfName = '';
    fileInput.value = '';
    invoiceSelect.innerHTML = '<option value="">Select an invoice...</option>';
    controls.style.display = 'none';
    stats.style.display = 'none';
    tableCont.style.display = 'none';
    uploadSec.style.display = 'block';
  }

  function debugDumpData() {
    console.log('========== DEBUG DATA DUMP ==========');
    console.log('Total rows in allData:', allData.length);
    console.log('Invoice order:', invoiceOrder);
    console.log('Current invoice:', currentInvoice);
    
    console.log('\nFirst 5 rows:');
    allData.slice(0, 5).forEach((row, idx) => {
      console.log(`\nRow ${idx}:`, {
        invoice: row.invoice_number,
        position: row.position,
        part: row.part_number,
        hasMetalContent: !!row.metal_content,
        metalContent: row.metal_content
      });
    });
    
    console.log('\nFull allData:', allData);
  }

  // ========= EXPORT TO DESCARTES =========
  function exportToDescartes() {
    if (!allData.length) {
      showAlert('No data to export.', 'error');
      return;
    }

    const exportRows = [];

    allData.forEach(item => {
      const supplierMid = lookupSupplierMid(item.supplier);
      
      // Build base row with template structure
      const baseRow = {
        'InvoiceNumber': item.invoice_number || '',
        'InvoiceDate': item.invoice_date || '',
        'InvoiceTotal': item.invoice_total || '',
        'SupplierMID': supplierMid,
        'SupplierName': item.supplier || '',
        'BuyerPartNumber': item.part_number || '',
        'SupplierPartNumber': item.part_number || '',
        'Quantity': item.quantity || '',
        'UnitOfMeasure': item.unit || 'ST',
        'Description': '',
        'UnitPrice': item.unit_price || '',
        'ItemTotal': item.line_total || '',
        'CurrencyCode': 'USD',
        'ExchangeRate': '',
        'CountryOfOrigin': item.country_of_origin || 'DE',
        'CountryOfExport': 'DE',
        'DateOfExport': '',
        'PortOfLading': '',
        'RelatedParty': '',
        'PO_Number': '',
        'PO_Date': '',
        'GrossWeight': '',
        'GrossWeightUnit': '',
        'NetWeight': item.net_weight || '',
        'TariffNumber': '',
        'TariffDescription': '',
        'Quantity1': '',
        'UnitOfMeasure1': '',
        'Quantity2': '',
        'UnitOfMeasure2': '',
        'Quantity3': '',
        'UnitOfMeasure3': '',
        'PrimarySPI': '',
        'SecondarySPI': '',
        'DeliverTo': '',
        'SoldTo': '',
        'SellerMID': '',
        'ShipperMID': '',
        'EntryDate': '',
        'ArrivalDate': '',
        'Carrier': '',
        'Vessel': '',
        'Voyage': '',
        'PortOfEntry': '',
        'PortOfUnloading': '',
        'LocationCode': '',
        'TotalCharges': '',
        'BillOfLadingNumber': '',
        'Container': '',
        'SecondaryTariffNumber': '',
        'SecondaryTariffdescription': '',
        'Secondary Quantity1': '',
        'Secondaryunitofmeasure1': '',
        'secondaryquantity2': '',
        'secondaryunitofmeasure2': '',
        'secondaryquantity3': '',
        'secondaryunitofmeasure3': '',
        'secondaryvalue': '',
        'FTZStatus': '',
        'FTZPrivilegedDate\u00a0': '',
        'ThirdTariffNumber': '',
        'ThirdTariffDescription': '',
        'ThirdTariffQuantity1': '',
        'ThirdTariffUnitofMeasure1': '',
        'ThirdTariffQuantity2': '',
        'ThirdTariffUnitofMeasure2': '',
        'ThirdTariffQuantity3': '',
        'ThirdTariffUnitofMeasure3': '',
        'Third Value': '',
        '4TariffNumber': '',
        '4TariffDescription': '',
        '4TariffQuantity1': '',
        '4TariffUnitofMeasure1': '',
        '4TariffQuantity2': '',
        '4TariffUnitofMeasure2': '',
        '4TariffQuantity3': '',
        '4TariffUnitofMeasure3': '',
        '4 Value': '',
        '5TariffNumber': '',
        '5TariffDescription': '',
        '5TariffQuantity1': '',
        '5TariffUnitofMeasure1': '',
        '5TariffQuantity2': '',
        '5TariffUnitofMeasure2': '',
        '5TariffQuantity3': '',
        '5TariffUnitofMeasure3': '',
        '5 Value': ''
      };

      // Fill in tariffs from database
      const tariffs = lookupTariffsByPart(item.part_number);
      const tariffFields = ['TariffNumber', 'SecondaryTariffNumber', 'ThirdTariffNumber', '4TariffNumber', '5TariffNumber'];
      const netWeight = item.net_weight || '';

      tariffs.forEach((tariff, idx) => {
        if (idx < tariffFields.length) {
          baseRow[tariffFields[idx]] = tariff;
          
          const startsWithExempt = String(tariff).startsWith('98') || String(tariff).startsWith('99');
          if (!startsWithExempt) {
            const uomInfo = lookupHtsUom(tariff);
            
            if (idx === 0) {
              baseRow['Quantity1'] = netWeight;
              baseRow['UnitOfMeasure1'] = uomInfo.uom1;
              if (uomInfo.uom2) {
                baseRow['Quantity2'] = netWeight;
                baseRow['UnitOfMeasure2'] = uomInfo.uom2;
              }
            } else if (idx === 1) {
              baseRow['Secondary Quantity1'] = netWeight;
              baseRow['Secondaryunitofmeasure1'] = uomInfo.uom1;
              if (uomInfo.uom2) {
                baseRow['secondaryquantity2'] = netWeight;
                baseRow['secondaryunitofmeasure2'] = uomInfo.uom2;
              }
            } else if (idx === 2) {
              baseRow['ThirdTariffQuantity1'] = netWeight;
              baseRow['ThirdTariffUnitofMeasure1'] = uomInfo.uom1;
              if (uomInfo.uom2) {
                baseRow['ThirdTariffQuantity2'] = netWeight;
                baseRow['ThirdTariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if (idx === 3) {
              baseRow['4TariffQuantity1'] = netWeight;
              baseRow['4TariffUnitofMeasure1'] = uomInfo.uom1;
              if (uomInfo.uom2) {
                baseRow['4TariffQuantity2'] = netWeight;
                baseRow['4TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            } else if (idx === 4) {
              baseRow['5TariffQuantity1'] = netWeight;
              baseRow['5TariffUnitofMeasure1'] = uomInfo.uom1;
              if (uomInfo.uom2) {
                baseRow['5TariffQuantity2'] = netWeight;
                baseRow['5TariffUnitofMeasure2'] = uomInfo.uom2;
              }
            }
          }
        }
      });

      exportRows.push(baseRow);

      // If item has metal content, create additional rows for each metal
      const metalContent = item.metal_content || { hasMetals: false, metals: [] };
      if (metalContent.hasMetals && metalContent.metals.length > 0) {
        metalContent.metals.forEach(metal => {
          const metalRow = { ...baseRow };
          
          // Update part numbers for metal content
          const metalType = metal.type.toLowerCase();
          if (metalType === 'steel') {
            metalRow['BuyerPartNumber'] = 'STEEL EXCL';
            metalRow['SupplierPartNumber'] = 'STEEL EXCL';
            metalRow['TariffNumber'] = '99030133';
            metalRow['SecondaryTariffNumber'] = '99038191';
          } else if (metalType === 'aluminum') {
            metalRow['BuyerPartNumber'] = 'ALUM EXCL';
            metalRow['SupplierPartNumber'] = 'ALUM EXCL';
            metalRow['TariffNumber'] = '99030133';
            metalRow['SecondaryTariffNumber'] = '99038508';
          } else if (metalType === 'copper') {
            metalRow['BuyerPartNumber'] = 'COPPER EXCL';
            metalRow['SupplierPartNumber'] = 'COPPER EXCL';
            metalRow['TariffNumber'] = '99030133';
          }
          
          metalRow['NetWeight'] = metal.weight || '';
          metalRow['Quantity'] = metal.weight || '';
          metalRow['Secondary Quantity1'] = metal.weight || '';
          metalRow['Secondaryunitofmeasure1'] = 'KG';
          metalRow['ItemTotal'] = '0';
          metalRow['UnitPrice'] = '0';
          
          if (metal.country) {
            metalRow['CountryOfOrigin'] = metal.country;
          }
          
          exportRows.push(metalRow);
        });
      }
    });

    // Create headers array
    const headers = [
      'InvoiceNumber','InvoiceDate','InvoiceTotal','SupplierMID','SupplierName',
      'BuyerPartNumber','SupplierPartNumber','Quantity','UnitOfMeasure','Description',
      'UnitPrice','ItemTotal','CurrencyCode','ExchangeRate','CountryOfOrigin',
      'CountryOfExport','DateOfExport','PortOfLading','RelatedParty','PO_Number',
      'PO_Date','GrossWeight','GrossWeightUnit','NetWeight','TariffNumber',
      'TariffDescription','Quantity1','UnitOfMeasure1','Quantity2','UnitOfMeasure2',
      'Quantity3','UnitOfMeasure3','PrimarySPI','SecondarySPI','DeliverTo','SoldTo',
      'SellerMID','ShipperMID','EntryDate','ArrivalDate','Carrier','Vessel','Voyage',
      'PortOfEntry','PortOfUnloading','LocationCode','TotalCharges','BillOfLadingNumber',
      'Container','SecondaryTariffNumber','SecondaryTariffdescription','Secondary Quantity1',
      'Secondaryunitofmeasure1','secondaryquantity2','secondaryunitofmeasure2',
      'secondaryquantity3','secondaryunitofmeasure3','secondaryvalue','FTZStatus',
      'FTZPrivilegedDate\u00a0','ThirdTariffNumber','ThirdTariffDescription',
      'ThirdTariffQuantity1','ThirdTariffUnitofMeasure1','ThirdTariffQuantity2',
      'ThirdTariffUnitofMeasure2','ThirdTariffQuantity3','ThirdTariffUnitofMeasure3',
      'Third Value','4TariffNumber','4TariffDescription','4TariffQuantity1',
      '4TariffUnitofMeasure1','4TariffQuantity2','4TariffUnitofMeasure2',
      '4TariffQuantity3','4TariffUnitofMeasure3','4 Value',
      '5TariffNumber','5TariffDescription','5TariffQuantity1',
      '5TariffUnitofMeasure1','5TariffQuantity2','5TariffUnitofMeasure2',
      '5TariffQuantity3','5TariffUnitofMeasure3','5 Value'
    ];

    const aoa = [headers];
    exportRows.forEach(r => {
      aoa.push(headers.map(h => (r[h] != null ? r[h] : '')));
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, 'DescartesUpload');

    const fname = (uploadedPdfName ? uploadedPdfName + '_' : '') + 'descartes_ci_upload.xlsx';
    XLSX.writeFile(wb, fname);
    
    showAlert(`Exported ${exportRows.length} rows to ${fname}`, 'success');
  }
</script>
</body>
</html>
